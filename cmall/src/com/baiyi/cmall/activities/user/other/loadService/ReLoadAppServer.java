package com.baiyi.cmall.activities.user.other.loadService;

import android.app.Notification;
import android.app.NotificationManager;
import android.app.PendingIntent;
import android.app.Service;
import android.content.Context;
import android.content.Intent;
import android.os.IBinder;

import com.baiyi.cmall.activities.main.home_pager.MainActivity;
import com.baiyi.cmall.R;

/**
 * 
 * @author sunxy
 * @label You can go as far as you want to go.
 * @date 2016-3-8 下午5:46:46
 */
public class ReLoadAppServer extends Service {
	// 获取消息线程
	private MessageThread messageThread = null;

	// 点击查看
	private Intent messageIntent = null;
	private PendingIntent messagePendingIntent = null;

	// 通知栏消息
	private int messageNotificationID = 1000;
	private Notification messageNotification = null;
	private NotificationManager messageNotificatioManager = null;

	public IBinder onBind(Intent intent) {
		return null;
	}

	@Override
	public int onStartCommand(Intent intent, int flags, int startId) {
		// 初始化
		messageNotification = new Notification();
		messageNotification.icon = R.drawable.app_icon;
		messageNotification.tickerText = "下载-Dmall";
		messageNotification.defaults = Notification.DEFAULT_SOUND;
		messageNotification.flags |= Notification.FLAG_AUTO_CANCEL;
		messageNotificatioManager = (NotificationManager) getSystemService(Context.NOTIFICATION_SERVICE);

		messageIntent = new Intent(this, MainActivity.class);
		messagePendingIntent = PendingIntent.getActivity(this, 0,
				messageIntent, 0);

		// 开启线程
		messageThread = new MessageThread();
		messageThread.isRunning = true;
		messageThread.start();

		return super.onStartCommand(intent, flags, startId);
	}

	/**
	 * 从服务器端获取消息
	 * 
	 */
	class MessageThread extends Thread {
		// 设置是否循环推送
		public boolean isRunning = true;

		@SuppressWarnings("deprecation")
		public void run() {
			// while (isRunning) {
			try {
				// 间隔时间
				Thread.sleep(1000);
				// 获取服务器消息
				String serverMessage = getServerMessage();
				if (serverMessage != null && !"".equals(serverMessage)) {
					// 更新通知栏
					messageNotification.setLatestEventInfo(
							getApplicationContext(), "新消息", "正在下载CMALL_App"
									+ serverMessage, messagePendingIntent);
					messageNotificatioManager.notify(messageNotificationID,
							messageNotification);

					// 每次通知完，通知ID递增一下，避免消息覆盖掉
					messageNotificationID++;
					ReLoadAppServer.this.stopSelf();
				}
			} catch (InterruptedException e) {
				e.printStackTrace();
			}
			// }
		}
	}

	@Override
	public void onDestroy() {
		// System.exit(0);
		messageThread.isRunning = false;
		super.onDestroy();
	}

	/**
	 * 模拟发送消息
	 * 
	 * @return 返回服务器要推送的消息，否则如果为空的话，不推送
	 */
	public String getServerMessage() {
		return " ";
	}
}
